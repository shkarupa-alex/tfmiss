from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import numpy as np
import tensorflow as tf
from tfmiss.keras.optimizers.adan import Adan


class AdanOptimizerTest(tf.test.TestCase):
    def test_dense_value(self):
        logits = tf.constant([
            [[0.3834889522317029, 0.18652422068782437], [0.5416385105321877, 0.7688347307618931],
             [0.217790919325616, 0.15262361602508145], [0.2878849762271264, 0.303517183413756]],
            [[0.575396293440796, 0.1937945842042471], [0.8515048936764875, 0.6082759528597521],
             [0.244061034387261, 0.6003517264187057], [0.6859539966321943, 0.5198978593981205]],
            [[0.3610914004327209, 0.36862621854042843], [0.5987028639328222, 0.659444080108686],
             [0.007242132828604975, 0.8057883687901827], [0.2878444083304914, 0.8037585089042157]],
            [[0.9682742254823508, 0.8033685400744861], [0.5634681959664141, 0.866969703248222],
             [0.15559689502741003, 0.2019452510527322], [0.5022437034539109, 0.02060094585527439]],
            [[0.07024793255130724, 0.9250163595307129], [0.7577723801679607, 0.9831952010937728],
             [0.29071966476410227, 0.6668720294403833], [0.5692100239777321, 0.0768018007818857]],
            [[0.9364803726429763, 0.003048170334680189], [0.2174190664238198, 0.5639216930749434],
             [0.03810156819314736, 0.9079015544559597], [0.45384361800440465, 0.23852113113902818]],
            [[0.7612423837745981, 0.07139997292488698], [0.7691063629177809, 0.4477965784803455],
             [0.45369956264823375, 0.610529191717423], [0.9398398146291436, 0.8149969007287517]],
            [[0.8523592275802878, 0.5669437663867238], [0.3755580315463406, 0.5345157509149302],
             [0.49289132309138584, 0.2624251305383454], [0.8983067036877381, 0.29240395916025474]],
            [[0.8249801893607751, 0.796818088911959], [0.8452020180686657, 0.12773879285629697],
             [0.5129248509630417, 0.6258146179509537], [0.7802920713460937, 0.21178474682109627]],
            [[0.9492749548462845, 0.9989193705269074], [0.7745610904434905, 0.2707049634807568],
             [0.298129028125938, 0.8923597130119965], [0.19711194075403338, 0.40087139018117]]], 'float32')
        targets = tf.constant([
            [[0.3706484442126573], [0.9120088220681468], [0.8002354619370015], [0.1404340849024026]],
            [[0.6983717383122452], [0.7516800505500254], [0.8739545056835875], [0.4384932111106432]],
            [[0.6527435852360429], [0.7623048790390828], [0.38295686895742076], [0.045712707742929126]],
            [[0.6818675631406735], [0.6233808405487737], [0.9570485572286584], [0.03659283629384047]],
            [[0.3349266363012273], [0.17621407995129712], [0.06932226643333994], [0.2133203445158769]],
            [[0.4572859905619785], [0.08999689428717572], [0.7617251196788672], [0.46156182410210855]],
            [[0.6886897863452727], [0.8836154248090233], [0.4212059466588135], [0.10048563036423053]],
            [[0.916738019979103], [0.48745919502299206], [0.3728910185868768], [0.1744337592170927]],
            [[0.8880334776379646], [0.6088421798176064], [0.9071319598757348], [0.043805577709025156]],
            [[0.831315229028722], [0.3143697252458306], [0.17493310992986955], [0.08316567541993414]]], 'float32')
        expected = np.array([
            [[0.9289467334747314], [0.5146288275718689]], [[0.9220327138900757], [0.5076063871383667]],
            [[0.9168685674667358], [0.49992406368255615]], [[0.9103225469589233], [0.49171045422554016]],
            [[0.9030662775039673], [0.48462384939193726]], [[0.8968232870101929], [0.4812500476837158]],
            [[0.8900850415229797], [0.47640958428382874]], [[0.8832252025604248], [0.47223883867263794]],
            [[0.8760951161384583], [0.46812891960144043]], [[0.8686503767967224], [0.463100403547287]],
            [[0.8632540106773376], [0.4596262276172638]], [[0.8573634028434753], [0.4559729993343353]],
            [[0.8516708016395569], [0.45187824964523315]], [[0.8454583287239075], [0.4475083649158478]],
            [[0.8389337062835693], [0.4425636827945709]], [[0.8328498005867004], [0.43917298316955566]],
            [[0.8264732360839844], [0.4350193440914154]], [[0.82002192735672], [0.43124037981033325]],
            [[0.813400387763977], [0.4275047779083252]], [[0.8065323233604431], [0.4231569468975067]],
            [[0.80103999376297], [0.4198095202445984]], [[0.7951650619506836], [0.4163317084312439]],
            [[0.7893124222755432], [0.4125168025493622]], [[0.7830501198768616], [0.4085090756416321]],
            [[0.7765785455703735], [0.40404653549194336]], [[0.7704830169677734], [0.4008208215236664]],
            [[0.7641345262527466], [0.396972119808197]], [[0.7577196359634399], [0.39344683289527893]],
            [[0.7511711120605469], [0.38998255133628845]], [[0.7443867921829224], [0.3859800398349762]],
            [[0.7388595342636108], [0.3828261196613312]], [[0.7329859137535095], [0.3795727789402008]],
            [[0.7270302772521973], [0.37600579857826233]], [[0.720673680305481], [0.37228384613990784]],
            [[0.7141689658164978], [0.36813363432884216]], [[0.7080681920051575], [0.3651346266269684]],
            [[0.7016918063163757], [0.3615509569644928]], [[0.69524747133255], [0.358289510011673]],
            [[0.688709557056427], [0.3551265299320221]], [[0.6819106340408325], [0.3514348864555359]],
            [[0.6764070987701416], [0.3485332727432251]], [[0.6706073880195618], [0.34557271003723145]],
            [[0.6646327376365662], [0.3423047959804535]], [[0.6582317352294922], [0.33891844749450684]],
            [[0.6517342329025269], [0.3350820243358612]], [[0.6457238793373108], [0.3323776125907898]],
            [[0.6393866539001465], [0.32909348607063293]], [[0.6329817175865173], [0.3261507749557495]],
            [[0.6265698671340942], [0.323360413312912]], [[0.6198352575302124], [0.32002702355384827]],
            [[0.614495575428009], [0.31745365262031555]], [[0.6089696288108826], [0.314875990152359]],
            [[0.6031749844551086], [0.3119952380657196]], [[0.596926212310791], [0.30904266238212585]],
            [[0.5906082987785339], [0.3055852949619293]], [[0.5849019289016724], [0.30325594544410706]],
            [[0.5788304805755615], [0.3003425598144531]], [[0.5727068185806274], [0.29779884219169617]],
            [[0.5667517781257629], [0.295471727848053]], [[0.560370922088623], [0.2925822138786316]],
            [[0.5554570555686951], [0.29042643308639526]], [[0.550549328327179], [0.28833135962486267]],
            [[0.5452848672866821], [0.28594115376472473]], [[0.5395824909210205], [0.28353622555732727]],
            [[0.5337619185447693], [0.2805502116680145]], [[0.5286846160888672], [0.2786788046360016]],
            [[0.5232804417610168], [0.27622315287590027]], [[0.5178651809692383], [0.2741659879684448]],
            [[0.5128597617149353], [0.27238839864730835]], [[0.5073079466819763], [0.2700363099575043]],
            [[0.5031635761260986], [0.2683844566345215]], [[0.49924784898757935], [0.26685720682144165]],
            [[0.4949122965335846], [0.26504790782928467]], [[0.4902312159538269], [0.2632829546928406]],
            [[0.4852747321128845], [0.26085349917411804]], [[0.48114466667175293], [0.25950565934181213]],
            [[0.4768204987049103], [0.25758376717567444]], [[0.4725375473499298], [0.2560825049877167]],
            [[0.46884122490882874], [0.25490865111351013]], [[0.46451807022094727], [0.2531607151031494]],
            [[0.4614015221595764], [0.2520714998245239]], [[0.4586614966392517], [0.25115615129470825]],
            [[0.45547565817832947], [0.24997539818286896]], [[0.45207396149635315], [0.24888837337493896]],
            [[0.4481975734233856], [0.247060626745224]], [[0.44515886902809143], [0.24626484513282776]],
            [[0.4420796036720276], [0.24491411447525024]], [[0.4390789270401001], [0.24399644136428833]],
            [[0.43670332431793213], [0.24343138933181763]], [[0.4336830973625183], [0.24230238795280457]],
            [[0.4316387474536896], [0.24178898334503174]], [[0.4300125241279602], [0.2414776235818863]],
            [[0.4279440939426422], [0.2409178465604782]], [[0.4257661998271942], [0.24048584699630737]],
            [[0.4229578375816345], [0.23925085365772247]], [[0.4209565222263336], [0.23899231851100922]],
            [[0.41902169585227966], [0.23820070922374725]], [[0.41718438267707825], [0.23784659802913666]],
            [[0.4159269630908966], [0.2378503382205963]], [[0.4140421748161316], [0.23730289936065674]]], 'float32')

        weights = tf.Variable([[0.9189467373291287], [0.5046289624616127]], trainable=True, dtype='float32')
        optimizer = Adan(learning_rate=0.01, weight_decay=0.0, beta_1=0.99, beta_2=0.92, beta_3=0.9, epsilon=1e-8)

        for e in range(10):
            for b in range(10):
                with tf.GradientTape() as tape:
                    loss = tf.reduce_mean((targets[b] - logits[b] @ weights) ** 2)
                grads = tape.gradient(loss, [weights])
                optimizer.apply_gradients(zip(grads, [weights]))

                actual = self.evaluate(weights)
                self.assertAllClose(actual, expected[e * 10 + b])

    def test_without_sparse(self):
        logits = tf.random.uniform((10, 4, 2), dtype='float32')
        targets = tf.random.uniform((10, 4, 1), dtype='float32')

        weights = tf.Variable([[0.9189467373291287], [0.5046289624616127]], trainable=True, dtype='float32')
        optimizer = Adan(
            learning_rate=0.01, weight_decay=0.0, beta_1=0.99, beta_2=0.92, beta_3=0.9, epsilon=1e-8,
            sparse_support=False)

        for e in range(10):
            for b in range(10):
                with tf.GradientTape() as tape:
                    loss = tf.reduce_mean((targets[b] - logits[b] @ weights) ** 2)
                grads = tape.gradient(loss, [weights])
                optimizer.apply_gradients(zip(grads, [weights]))

                actual = self.evaluate(weights)
                self.assertTrue(np.isfinite(actual).all())

    def test_sparse_value(self):
        indices = tf.constant([
            [0, 1, 2, 3], [4, 3, 2, 1], [0, 1, 2, 3], [4, 3, 2, 1], [0, 1, 2, 3], [4, 3, 2, 1], [0, 4, 3, 2],
            [1, 0, 4, 3], [2, 1, 0, 4], [3, 2, 1, 0]], 'int32')
        targets = tf.ones([10, 4, 2], 'float32')
        expected = np.array([
            [[0.24922160804271698, 0.384485125541687], [0.13467898964881897, 0.592473566532135],
             [0.04158169403672218, 0.5822573900222778], [0.8387652635574341, 0.3259560465812683],
             [0.09411077201366425, 0.33044469356536865]],
            [[0.24922160804271698, 0.384485125541687], [0.14468170702457428, 0.6024778485298157],
             [0.05158420279622078, 0.5922616720199585], [0.84876549243927, 0.3359593152999878],
             [0.10411076992750168, 0.3404446840286255]],
            [[0.25922462344169617, 0.3944886028766632], [0.15468887984752655, 0.6124908328056335],
             [0.061590760946273804, 0.602274477481842], [0.8587807416915894, 0.34596818685531616],
             [0.10411076992750168, 0.3404446840286255]],
            [[0.25922462344169617, 0.3944886028766632], [0.16470226645469666, 0.6225162744522095],
             [0.0716029480099678, 0.6122994422912598], [0.8688195943832397, 0.3559849262237549],
             [0.11411342024803162, 0.35044801235198975]],
            [[0.26923272013664246, 0.4044981598854065], [0.17472364008426666, 0.6325579285621643],
             [0.08162237703800201, 0.6223402619361877], [0.8788900971412659, 0.3660118281841278],
             [0.11411342024803162, 0.35044801235198975]],
            [[0.26923272013664246, 0.4044981598854065], [0.1847548484802246, 0.642619788646698],
             [0.09165069460868835, 0.6324008703231812], [0.8890003561973572, 0.37605127692222595],
             [0.12412038445472717, 0.36045703291893005]],
            [[0.2792479395866394, 0.41451627016067505], [0.1847548484802246, 0.642619788646698],
             [0.10168957710266113, 0.6424852013587952], [0.8991586565971375, 0.3861056864261627],
             [0.13413335382938385, 0.37047410011291504]],
            [[0.2892723083496094, 0.4245454668998718], [0.19479773938655853, 0.6527059674263],
             [0.10168957710266113, 0.6424852013587952], [0.9093731641769409, 0.3961775302886963],
             [0.14415405690670013, 0.38050153851509094]],
            [[0.2993079721927643, 0.43458834290504456], [0.20485420525074005, 0.6628207564353943],
             [0.11174070835113525, 0.6525974869728088], [0.9093731641769409, 0.3961775302886963],
             [0.1541842520236969, 0.39054179191589355]],
            [[0.3093571066856384, 0.44464758038520813], [0.21492616832256317, 0.6729686260223389],
             [0.12180580198764801, 0.662742018699646], [0.9196518063545227, 0.4062693119049072],
             [0.1541842520236969, 0.39054179191589355]],
            [[0.3194218873977661, 0.45472589135169983], [0.2250155508518219, 0.6831542253494263],
             [0.1318865865468979, 0.6729233860969543], [0.9300017952919006, 0.41638365387916565],
             [0.1541842520236969, 0.39054179191589355]],
            [[0.3194218873977661, 0.45472589135169983], [0.23512433469295502, 0.6933825016021729],
             [0.14198480546474457, 0.6831462979316711], [0.9404286742210388, 0.4265231788158417],
             [0.1642257422208786, 0.40059730410575867]],
            [[0.3295045495033264, 0.4648261070251465], [0.2452545017004013, 0.7036585211753845],
             [0.15210223197937012, 0.6934157609939575], [0.9509352445602417, 0.4366905987262726],
             [0.1642257422208786, 0.40059730410575867]],
            [[0.3295045495033264, 0.4648261070251465], [0.25540807843208313, 0.7139877080917358],
             [0.1622406244277954, 0.7037369608879089], [0.9615195989608765, 0.44688868522644043],
             [0.1742803454399109, 0.4106706380844116]],
            [[0.3396073877811432, 0.4749510586261749], [0.26558712124824524, 0.7243757247924805],
             [0.1724018007516861, 0.7141153812408447], [0.9721722602844238, 0.45712029933929443],
             [0.1742803454399109, 0.4106706380844116]],
            [[0.3396073877811432, 0.4749510586261749], [0.2757937014102936, 0.7348286509513855],
             [0.18258757889270782, 0.7245568633079529], [0.9828720092773438, 0.4673883318901062],
             [0.1843498945236206, 0.42076438665390015]],
            [[0.34973272681236267, 0.4851037263870239], [0.2757937014102936, 0.7348286509513855],
             [0.19279979169368744, 0.7350675463676453], [0.993580162525177, 0.4776958227157593],
             [0.19443626701831818, 0.43088117241859436]],
            [[0.3598829209804535, 0.495287150144577], [0.2860299348831177, 0.7453528046607971],
             [0.19279979169368744, 0.7350675463676453], [1.004233717918396, 0.4880458414554596],
             [0.20454134047031403, 0.44102373719215393]],
            [[0.37006041407585144, 0.5055044293403625], [0.29629796743392944, 0.7559549808502197],
             [0.20304030179977417, 0.7456539273262024], [1.004233717918396, 0.4880458414554596],
             [0.21466703712940216, 0.4511948525905609]],
            [[0.3802676498889923, 0.5157588124275208], [0.3065999746322632, 0.7666423916816711],
             [0.21331098675727844, 0.756322979927063], [1.0147382020950317, 0.49844157695770264],
             [0.21466703712940216, 0.4511948525905609]],
            [[0.39050716161727905, 0.5260535478591919], [0.316938191652298, 0.7774227261543274],
             [0.22361375391483307, 0.7670820951461792], [1.0249642133712769, 0.5088863372802734],
             [0.21466703712940216, 0.4511948525905609]],
            [[0.39050716161727905, 0.5260535478591919], [0.3273148536682129, 0.788304328918457],
             [0.23395052552223206, 0.7779392004013062], [1.0347524881362915, 0.5193835496902466],
             [0.2248152792453766, 0.4613973796367645]],
            [[0.400781512260437, 0.5363921523094177], [0.33773231506347656, 0.7992960214614868],
             [0.24432328343391418, 0.788902759552002], [1.0439306497573853, 0.5299367308616638],
             [0.2248152792453766, 0.4613973796367645]],
            [[0.400781512260437, 0.5363921523094177], [0.3481929302215576, 0.8104073405265808],
             [0.25473400950431824, 0.7999818921089172], [1.0523412227630615, 0.5405495762825012],
             [0.2349880337715149, 0.47163423895835876]],
            [[0.4110933244228363, 0.54677814245224], [0.35869911313056946, 0.8216485381126404],
             [0.2651847302913666, 0.8111864328384399], [1.0598695278167725, 0.5512259602546692],
             [0.2349880337715149, 0.47163423895835876]],
            [[0.4110933244228363, 0.54677814245224], [0.36925333738327026, 0.8330307602882385],
             [0.27567750215530396, 0.8225269913673401], [1.066458821296692, 0.5619698166847229],
             [0.24518728256225586, 0.4819084405899048]],
            [[0.4214453399181366, 0.55721515417099], [0.36925333738327026, 0.8330307602882385],
             [0.2862144708633423, 0.8340150117874146], [1.0721087455749512, 0.5727853775024414],
             [0.25541505217552185, 0.4922230839729309]],
            [[0.43184030055999756, 0.5677070617675781], [0.37985819578170776, 0.8445659875869751],
             [0.2862144708633423, 0.8340150117874146], [1.0768611431121826, 0.5836769938468933],
             [0.26567336916923523, 0.5025813579559326]],
            [[0.4422810673713684, 0.5782578587532043], [0.3905162811279297, 0.8562670946121216],
             [0.2967977523803711, 0.8456628918647766], [1.0768611431121826, 0.5836769938468933],
             [0.27596431970596313, 0.5129866003990173]],
            [[0.45277056097984314, 0.5888717174530029], [0.4012303054332733, 0.8681480288505554],
             [0.30742955207824707, 0.8574839234352112], [1.0807826519012451, 0.5946493148803711],
             [0.27596431970596313, 0.5129866003990173]],
            [[0.4633118212223053, 0.5995529890060425], [0.4120030403137207, 0.8802237510681152],
             [0.3181121349334717, 0.8694925308227539], [1.0839502811431885, 0.6057072281837463],
             [0.27596431970596313, 0.5129866003990173]],
            [[0.4633118212223053, 0.5995529890060425], [0.42283740639686584, 0.8925101161003113],
             [0.32884782552719116, 0.8817041516304016], [1.0864415168762207, 0.6168558597564697],
             [0.2862900197505951, 0.5234422087669373]],
            [[0.4739079773426056, 0.6103062033653259], [0.4337363839149475, 0.905023992061615],
             [0.33963900804519653, 0.8941352963447571], [1.0883291959762573, 0.6281006336212158],
             [0.2862900197505951, 0.5234422087669373]],
            [[0.4739079773426056, 0.6103062033653259], [0.4447031021118164, 0.917782723903656],
             [0.35048815608024597, 0.9068032503128052], [1.0896788835525513, 0.6394473314285278],
             [0.296652615070343, 0.5339516997337341]],
            [[0.4845622777938843, 0.6211362481117249], [0.4557407796382904, 0.9308038949966431],
             [0.36139777302742004, 0.9197258949279785], [1.0905479192733765, 0.6509021520614624],
             [0.296652615070343, 0.5339516997337341]],
            [[0.4845622777938843, 0.6211362481117249], [0.4668528139591217, 0.9441043138504028],
             [0.37237051129341125, 0.932921290397644], [1.0909862518310547, 0.6624716520309448],
             [0.3070542812347412, 0.544518768787384]],
            [[0.49527809023857117, 0.6320481300354004], [0.4668528139591217, 0.9441043138504028],
             [0.3834090828895569, 0.9464064836502075], [1.0910366773605347, 0.6741628646850586],
             [0.31749725341796875, 0.5551472902297974]],
            [[0.506058931350708, 0.6430472135543823], [0.47804272174835205, 0.9576987028121948],
             [0.3834090828895569, 0.9464064836502075], [1.0907357931137085, 0.685983419418335],
             [0.3279837965965271, 0.5658411979675293]],
            [[0.5169084072113037, 0.6541391611099243], [0.4893142282962799, 0.9715975522994995],
             [0.39451631903648376, 0.9601961374282837], [1.0907357931137085, 0.685983419418335],
             [0.3385162353515625, 0.5766047239303589]],
            [[0.5278303623199463, 0.6653299927711487], [0.5006712079048157, 0.9858037233352661],
             [0.4056951701641083, 0.9743001461029053], [1.090114951133728, 0.6979413628578186],
             [0.3385162353515625, 0.5766047239303589]],
            [[0.5388287305831909, 0.6766261458396912], [0.5121178030967712, 1.0003077983856201],
             [0.41694867610931396, 0.9887200593948364], [1.0892009735107422, 0.7100455164909363],
             [0.3385162353515625, 0.5766047239303589]],
            [[0.5388287305831909, 0.6766261458396912], [0.523658275604248, 1.015081524848938],
             [0.4282800853252411, 1.0034438371658325], [1.0880168676376343, 0.7223053574562073],
             [0.34909698367118835, 0.5874422192573547]],
            [[0.5499077439308167, 0.6880344748497009], [0.5352972149848938, 1.0300695896148682],
             [0.4396927058696747, 1.0184390544891357], [1.086582064628601, 0.734731137752533],
             [0.34909698367118835, 0.5874422192573547]],
            [[0.5499077439308167, 0.6880344748497009], [0.5470395088195801, 1.045181393623352],
             [0.4511900842189789, 1.0336443185806274], [1.0849134922027588, 0.7473340630531311],
             [0.35972848534584045, 0.5983582735061646]],
            [[0.5610717535018921, 0.6995623111724854], [0.5588902235031128, 1.0602850914001465],
             [0.46277591586112976, 1.0489609241485596], [1.083025336265564, 0.7601262927055359],
             [0.35972848534584045, 0.5983582735061646]],
            [[0.5610717535018921, 0.6995623111724854], [0.5708548426628113, 1.0752087831497192],
             [0.4744541049003601, 1.0642478466033936], [1.0809298753738403, 0.7731210589408875],
             [0.37041327357292175, 0.6093577742576599]],
            [[0.5723254084587097, 0.7112175822257996], [0.5708548426628113, 1.0752087831497192],
             [0.4862287640571594, 1.07932448387146], [1.0786375999450684, 0.786332905292511],
             [0.38115394115448, 0.6204458475112915]],
            [[0.5836736559867859, 0.7230086922645569], [0.5829392075538635, 1.089752197265625],
             [0.4862287640571594, 1.07932448387146], [1.0761572122573853, 0.7997776865959167],
             [0.39195314049720764, 0.6316278576850891]],
            [[0.5951216220855713, 0.7349448800086975], [0.5951495170593262, 1.1037107706069946],
             [0.4981042146682739, 1.0939850807189941], [1.0761572122573853, 0.7997776865959167],
             [0.4028136730194092, 0.642909586429596]],
            [[0.60667484998703, 0.7470360398292542], [0.6074925065040588, 1.1169044971466064],
             [0.5100851058959961, 1.1080245971679688], [1.0734962224960327, 0.8134728670120239],
             [0.4028136730194092, 0.642909586429596]],
            [[0.6183391809463501, 0.7592929005622864], [0.6199753284454346, 1.1292012929916382],
             [0.5221763253211975, 1.1212676763534546], [1.0706605911254883, 0.8274374604225159],
             [0.4028136730194092, 0.642909586429596]],
            [[0.6183391809463501, 0.7592929005622864], [0.6326056718826294, 1.140527367591858],
             [0.5343830585479736, 1.1335906982421875], [1.067655324935913, 0.841692328453064],
             [0.4137383997440338, 0.6542971730232239]],
            [[0.6301209330558777, 0.7717271447181702], [0.6453918814659119, 1.1508632898330688],
             [0.5467108488082886, 1.144929051399231], [1.0644843578338623, 0.8562602400779724],
             [0.4137383997440338, 0.6542971730232239]],
            [[0.6301209330558777, 0.7717271447181702], [0.6583429574966431, 1.160231351852417],
             [0.5591656565666199, 1.1552711725234985], [1.0611505508422852, 0.8711660504341125],
             [0.4247303009033203, 0.6657971739768982]],
            [[0.6420267820358276, 0.7843515276908875], [0.6714686751365662, 1.168681025505066],
             [0.5717538595199585, 1.1646451950073242], [1.057655930519104, 0.8864364624023438],
             [0.4247303009033203, 0.6657971739768982]],
            [[0.6420267820358276, 0.7843515276908875], [0.6847795844078064, 1.1762763261795044],
             [0.5844822525978088, 1.1731042861938477], [1.0540016889572144, 0.9021000266075134],
             [0.4357924461364746, 0.6774165034294128]],
            [[0.654063880443573, 0.7971799373626709], [0.6847795844078064, 1.1762763261795044],
             [0.5973581671714783, 1.1807141304016113], [1.0501880645751953, 0.918186604976654],
             [0.44692811369895935, 0.6891627311706543]],
            [[0.6662399768829346, 0.8102275133132935], [0.6982872486114502, 1.1830862760543823],
             [0.5973581671714783, 1.1807141304016113], [1.0462146997451782, 0.9347265362739563],
             [0.45814064145088196, 0.7010439038276672]],
            [[0.6785633563995361, 0.8235108852386475], [0.7120042443275452, 1.1891794204711914],
             [0.6103894710540771, 1.1875444650650024], [1.0462146997451782, 0.9347265362739563],
             [0.46943357586860657, 0.7130686640739441]],
            [[0.6910430788993835, 0.8370481729507446], [0.7259442806243896, 1.1946204900741577],
             [0.6235846877098083, 1.1936639547348022], [1.0420805215835571, 0.951748788356781],
             [0.46943357586860657, 0.7130686640739441]],
            [[0.7036888599395752, 0.8508591651916504], [0.7401224374771118, 1.199468731880188],
             [0.6369530558586121, 1.199136734008789], [1.0377838611602783, 0.9692784547805786],
             [0.46943357586860657, 0.7130686640739441]],
            [[0.7036888599395752, 0.8508591651916504], [0.7545552253723145, 1.2037771940231323],
             [0.6505045890808105, 1.2040213346481323], [1.0333226919174194, 0.987332284450531],
             [0.48081064224243164, 0.7252464294433594]],
            [[0.7165112495422363, 0.8649653792381287], [0.769260823726654, 1.2075934410095215],
             [0.6642501354217529, 1.2083704471588135], [1.0286948680877686, 1.0059120655059814],
             [0.48081064224243164, 0.7252464294433594]],
            [[0.7165112495422363, 0.8649653792381287], [0.7842592000961304, 1.2109591960906982],
             [0.6782015562057495, 1.2122306823730469], [1.0238986015319824, 1.0249955654144287],
             [0.4922757148742676, 0.7375874519348145]],
            [[0.7295217514038086, 0.8793901801109314], [0.7995723485946655, 1.2139114141464233],
             [0.6923717260360718, 1.2156434059143066], [1.0189329385757446, 1.0445241928100586],
             [0.4922757148742676, 0.7375874519348145]],
            [[0.7295217514038086, 0.8793901801109314], [0.8152245283126831, 1.2164825201034546],
             [0.7067747712135315, 1.2186449766159058], [1.0137989521026611, 1.0643901824951172],
             [0.5038329362869263, 0.750102698802948]],
            [[0.7427329421043396, 0.8941585421562195], [0.8152245283126831, 1.2164825201034546],
             [0.7214261889457703, 1.2212674617767334], [1.0085015296936035, 1.0844264030456543],
             [0.5154865980148315, 0.7628042697906494]],
            [[0.7561585307121277, 0.909296989440918], [0.8312423229217529, 1.2187012434005737],
             [0.7214261889457703, 1.2212674617767334], [1.0030512809753418, 1.1044056415557861],
             [0.5272412896156311, 0.7757052183151245]],
            [[0.7698134779930115, 0.9248328804969788], [0.8476549983024597, 1.2205928564071655],
             [0.7363429665565491, 1.223539113998413], [1.0030512809753418, 1.1044056415557861],
             [0.5391018986701965, 0.7888199687004089]],
            [[0.7837142944335938, 0.9407934546470642], [0.8644945025444031, 1.222179651260376],
             [0.7515437602996826, 1.225484848022461], [0.9974682331085205, 1.1240564584732056],
             [0.5391018986701965, 0.7888199687004089]],
            [[0.7978789806365967, 0.9572040438652039], [0.8817954659461975, 1.2234814167022705],
             [0.7670491933822632, 1.2271267175674438], [0.9917853474617004, 1.1430960893630981],
             [0.5391018986701965, 0.7888199687004089]],
            [[0.7978789806365967, 0.9572040438652039], [0.899594783782959, 1.2245157957077026],
             [0.7828819751739502, 1.2284843921661377], [0.986052930355072, 1.1612721681594849],
             [0.5510735511779785, 0.8021641373634338]],
            [[0.8123273849487305, 0.9740851521492004], [0.9179311990737915, 1.2252984046936035],
             [0.7990670800209045, 1.2295751571655273], [0.9803410768508911, 1.1783959865570068],
             [0.5510735511779785, 0.8021641373634338]],
            [[0.8123273849487305, 0.9740851521492004], [0.936843752861023, 1.2258431911468506],
             [0.815632164478302, 1.230414628982544], [0.9747380614280701, 1.1943575143814087],
             [0.5631617903709412, 0.8157549500465393]],
            [[0.8270813226699829, 0.9914478659629822], [0.9563695192337036, 1.2261626720428467],
             [0.832607626914978, 1.2310166358947754], [0.9693427085876465, 1.2091199159622192],
             [0.5631617903709412, 0.8157549500465393]],
            [[0.8270813226699829, 0.9914478659629822], [0.9765394926071167, 1.2262680530548096],
             [0.8500267863273621, 1.231393575668335], [0.9642506241798401, 1.2227027416229248],
             [0.5753724575042725, 0.8296111822128296]],
            [[0.8421646356582642, 1.0092872381210327], [0.9765394926071167, 1.2262680530548096],
             [0.8679260015487671, 1.2315565347671509], [0.9595396518707275, 1.2351620197296143],
             [0.5877118706703186, 0.843753457069397]],
            [[0.8576034307479858, 1.0275728702545166], [0.9973721504211426, 1.226169466972351],
             [0.8679260015487671, 1.2315565347671509], [0.9552600979804993, 1.2465736865997314],
             [0.6001867651939392, 0.8582042455673218]],
            [[0.8734261393547058, 1.0462374687194824], [1.0188640356063843, 1.225875973701477],
             [0.8863445520401001, 1.2315155267715454], [0.9552600979804993, 1.2465736865997314],
             [0.6128043532371521, 0.8729879260063171]],
            [[0.8896633386611938, 1.0651651620864868], [1.0409764051437378, 1.225395679473877],
             [0.9053241014480591, 1.231279730796814], [0.9514331221580505, 1.257021188735962],
             [0.6128043532371521, 0.8729879260063171]],
            [[0.9063475728034973, 1.084183692932129], [1.0636194944381714, 1.2247360944747925],
             [0.9249078035354614, 1.2308571338653564], [0.9480558633804321, 1.2665878534317017],
             [0.6128043532371521, 0.8729879260063171]],
            [[0.9063475728034973, 1.084183692932129], [1.0866363048553467, 1.223904013633728],
             [0.9451382160186768, 1.2302552461624146], [0.9451091885566711, 1.275352954864502],
             [0.6255724430084229, 0.888130784034729]],
            [[0.9235125780105591, 1.1030669212341309], [1.1097947359085083, 1.2229053974151611],
             [0.9660539627075195, 1.2294807434082031], [0.9425650238990784, 1.2833890914916992],
             [0.6255724430084229, 0.888130784034729]],
            [[0.9235125780105591, 1.1030669212341309], [1.1327954530715942, 1.2217458486557007],
             [0.9876841306686401, 1.2285397052764893], [0.9403918981552124, 1.2907617092132568],
             [0.6384994387626648, 0.9036608934402466]],
            [[0.9411920309066772, 1.121553897857666], [1.1553031206130981, 1.2204303741455078],
             [1.0100395679473877, 1.2274376153945923], [0.9385583400726318, 1.2975293397903442],
             [0.6384994387626648, 0.9036608934402466]],
            [[0.9411920309066772, 1.121553897857666], [1.1769943237304688, 1.218963384628296],
             [1.0331004858016968, 1.226179599761963], [0.9370347261428833, 1.303743839263916],
             [0.6515944600105286, 0.9196075201034546]],
            [[0.9594171643257141, 1.139382243156433], [1.1769943237304688, 1.218963384628296],
             [1.0568000078201294, 1.2247700691223145], [0.9357942342758179, 1.3094507455825806],
             [0.6648673415184021, 0.9360002279281616]],
            [[0.9782132506370544, 1.1563262939453125], [1.197605848312378, 1.2173490524291992],
             [1.0568000078201294, 1.2247700691223145], [0.9348130226135254, 1.3146905899047852],
             [0.678328812122345, 0.9528671503067017]],
            [[0.9975934624671936, 1.1722254753112793], [1.216963529586792, 1.2155911922454834],
             [1.0810059309005737, 1.2232131958007812], [0.9348130226135254, 1.3146905899047852],
             [0.6919904947280884, 0.970232367515564]],
            [[1.0175502300262451, 1.1869932413101196], [1.2349853515625, 1.2136930227279663],
             [1.1055070161819458, 1.221512794494629], [0.9340701699256897, 1.319498896598816],
             [0.6919904947280884, 0.970232367515564]],
            [[1.038043737411499, 1.2006090879440308], [1.2516658306121826, 1.2116576433181763],
             [1.1300121545791626, 1.2196722030639648], [0.9335474371910095, 1.3239072561264038],
             [0.6919904947280884, 0.970232367515564]],
            [[1.038043737411499, 1.2006090879440308], [1.267052173614502, 1.209487795829773],
             [1.154173493385315, 1.2176945209503174], [0.9332290887832642, 1.3279435634613037],
             [0.7058651447296143, 0.9881114959716797]],
            [[1.0589873790740967, 1.2131016254425049], [1.2812227010726929, 1.2071858644485474],
             [1.1776317358016968, 1.2155823707580566], [0.9331014156341553, 1.3316326141357422],
             [0.7058651447296143, 0.9881114959716797]],
            [[1.0589873790740967, 1.2131016254425049], [1.2942698001861572, 1.2047539949417114],
             [1.2000716924667358, 1.2133383750915527], [0.9331524968147278, 1.3349965810775757],
             [0.7199666500091553, 1.0065048933029175]],
            [[1.080234169960022, 1.2245302200317383], [1.3062889575958252, 1.2021939754486084],
             [1.2212638854980469, 1.2109646797180176], [0.9333720803260803, 1.33805513381958],
             [0.7199666500091553, 1.0065048933029175]],
            [[1.080234169960022, 1.2245302200317383], [1.317372441291809, 1.1995075941085815],
             [1.2410798072814941, 1.208463191986084], [0.9337512850761414, 1.3408260345458984],
             [0.7343102693557739, 1.0253887176513672]],
            [[1.1015701293945312, 1.234969973564148], [1.317372441291809, 1.1995075941085815],
             [1.2594815492630005, 1.2058355808258057], [0.9342823028564453, 1.343325138092041],
             [0.7489127516746521, 1.0447030067443848]],
            [[1.1227221488952637, 1.2445014715194702], [1.327605962753296, 1.1966960430145264],
             [1.2594815492630005, 1.2058355808258057], [0.9349583983421326, 1.3455668687820435],
             [0.7637924551963806, 1.0643386840820312]],
            [[1.143385887145996, 1.2532039880752563], [1.3370671272277832, 1.193760633468628],
             [1.276498556137085, 1.2030832767486572], [0.9349583983421326, 1.3455668687820435],
             [0.7789696455001831, 1.0841280221939087]],
            [[1.163268804550171, 1.2611520290374756], [1.3458253145217896, 1.190702199935913],
             [1.292202115058899, 1.2002075910568237], [0.9357737898826599, 1.3475641012191772],
             [0.7789696455001831, 1.0841280221939087]]], 'float32')

        weights = tf.Variable([
            [0.23922160713307927, 0.3744851446884956], [0.12467899195548227, 0.582473576084052],
            [0.03158169648583875, 0.5722574065524645], [0.8287652988660922, 0.315956053134146],
            [0.09411076902398452, 0.33044468551739103]], trainable=True, dtype='float32')
        optimizer = Adan(learning_rate=0.01, weight_decay=0.0, beta_1=0.99, beta_2=0.92, beta_3=0.9, epsilon=1e-8)

        for e in range(10):
            for b in range(10):
                with tf.GradientTape() as tape:
                    loss = tf.reduce_mean((targets[b] - tf.nn.embedding_lookup(weights, indices[b])) ** 2)
                grads = tape.gradient(loss, [weights])
                optimizer.apply_gradients(zip(grads, [weights]))

                actual = self.evaluate(weights)
                self.assertAllClose(actual, expected[e * 10 + b])

    def test_lr(self):
        opt_1 = Adan(learning_rate=1.0)
        opt_2 = Adan(learning_rate=lambda: tf.constant(0.5, 'float32'))
        opt_3 = Adan.from_config(opt_2.get_config())

        self.assertIsInstance(opt_1.lr, tf.Variable)
        self.assertIsInstance(opt_2.lr, tf.Variable)
        self.assertIsInstance(opt_3.lr, tf.Variable)

        self.assertAllClose(self.evaluate(opt_1.learning_rate), 1.0)
        self.assertAllClose(self.evaluate(opt_2.learning_rate), 0.5)
        self.assertAllClose(self.evaluate(opt_3.learning_rate), 0.5)


if __name__ == "__main__":
    tf.test.main()
