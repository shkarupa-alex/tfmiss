from __future__ import absolute_import
from __future__ import division
from __future__ import print_function

import numpy as np
import tensorflow as tf
from tfmiss.keras.optimizers.lion import Lion


class LionOptimizerTest(tf.test.TestCase):
    def test_dense_value(self):
        logits = tf.constant([
            [[0.3834889522317029, 0.18652422068782437], [0.5416385105321877, 0.7688347307618931],
             [0.217790919325616, 0.15262361602508145], [0.2878849762271264, 0.303517183413756]],
            [[0.575396293440796, 0.1937945842042471], [0.8515048936764875, 0.6082759528597521],
             [0.244061034387261, 0.6003517264187057], [0.6859539966321943, 0.5198978593981205]],
            [[0.3610914004327209, 0.36862621854042843], [0.5987028639328222, 0.659444080108686],
             [0.007242132828604975, 0.8057883687901827], [0.2878444083304914, 0.8037585089042157]],
            [[0.9682742254823508, 0.8033685400744861], [0.5634681959664141, 0.866969703248222],
             [0.15559689502741003, 0.2019452510527322], [0.5022437034539109, 0.02060094585527439]],
            [[0.07024793255130724, 0.9250163595307129], [0.7577723801679607, 0.9831952010937728],
             [0.29071966476410227, 0.6668720294403833], [0.5692100239777321, 0.0768018007818857]],
            [[0.9364803726429763, 0.003048170334680189], [0.2174190664238198, 0.5639216930749434],
             [0.03810156819314736, 0.9079015544559597], [0.45384361800440465, 0.23852113113902818]],
            [[0.7612423837745981, 0.07139997292488698], [0.7691063629177809, 0.4477965784803455],
             [0.45369956264823375, 0.610529191717423], [0.9398398146291436, 0.8149969007287517]],
            [[0.8523592275802878, 0.5669437663867238], [0.3755580315463406, 0.5345157509149302],
             [0.49289132309138584, 0.2624251305383454], [0.8983067036877381, 0.29240395916025474]],
            [[0.8249801893607751, 0.796818088911959], [0.8452020180686657, 0.12773879285629697],
             [0.5129248509630417, 0.6258146179509537], [0.7802920713460937, 0.21178474682109627]],
            [[0.9492749548462845, 0.9989193705269074], [0.7745610904434905, 0.2707049634807568],
             [0.298129028125938, 0.8923597130119965], [0.19711194075403338, 0.40087139018117]]], 'float32')
        targets = tf.constant([
            [[0.3706484442126573], [0.9120088220681468], [0.8002354619370015], [0.1404340849024026]],
            [[0.6983717383122452], [0.7516800505500254], [0.8739545056835875], [0.4384932111106432]],
            [[0.6527435852360429], [0.7623048790390828], [0.38295686895742076], [0.045712707742929126]],
            [[0.6818675631406735], [0.6233808405487737], [0.9570485572286584], [0.03659283629384047]],
            [[0.3349266363012273], [0.17621407995129712], [0.06932226643333994], [0.2133203445158769]],
            [[0.4572859905619785], [0.08999689428717572], [0.7617251196788672], [0.46156182410210855]],
            [[0.6886897863452727], [0.8836154248090233], [0.4212059466588135], [0.10048563036423053]],
            [[0.916738019979103], [0.48745919502299206], [0.3728910185868768], [0.1744337592170927]],
            [[0.8880334776379646], [0.6088421798176064], [0.9071319598757348], [0.043805577709025156]],
            [[0.831315229028722], [0.3143697252458306], [0.17493310992986955], [0.08316567541993414]]], 'float32')
        expected = np.array([
            [[0.9199467301368713], [0.5056289434432983]], [[0.9189467430114746], [0.5046289563179016]],
            [[0.9179467558860779], [0.5036289691925049]], [[0.9169467687606812], [0.5026289820671082]],
            [[0.9159467816352844], [0.5016289949417114]], [[0.9149467945098877], [0.5006290078163147]],
            [[0.913946807384491], [0.49962902069091797]], [[0.9129468202590942], [0.49862903356552124]],
            [[0.9119468331336975], [0.4976290464401245]], [[0.9109468460083008], [0.4966290593147278]],
            [[0.909946858882904], [0.49562907218933105]], [[0.9089468717575073], [0.4946290850639343]],
            [[0.9079468846321106], [0.4936290979385376]], [[0.9069468975067139], [0.49262911081314087]],
            [[0.9059469103813171], [0.49162912368774414]], [[0.9049469232559204], [0.4906291365623474]],
            [[0.9039469361305237], [0.4896291494369507]], [[0.902946949005127], [0.48862916231155396]],
            [[0.9019469618797302], [0.4876291751861572]], [[0.9009469747543335], [0.4866291880607605]],
            [[0.8999469876289368], [0.48562920093536377]], [[0.89894700050354], [0.48462921380996704]],
            [[0.8979470133781433], [0.4836292266845703]], [[0.8969470262527466], [0.4826292395591736]],
            [[0.8959470391273499], [0.48162925243377686]], [[0.8949470520019531], [0.4806292653083801]],
            [[0.8939470648765564], [0.4796292781829834]], [[0.8929470777511597], [0.47862929105758667]],
            [[0.8919470906257629], [0.47762930393218994]], [[0.8909471035003662], [0.4766293168067932]],
            [[0.8899471163749695], [0.4756293296813965]], [[0.8889471292495728], [0.47462934255599976]],
            [[0.887947142124176], [0.473629355430603]], [[0.8869471549987793], [0.4726293683052063]],
            [[0.8859471678733826], [0.47162938117980957]], [[0.8849471807479858], [0.47062939405441284]],
            [[0.8839471936225891], [0.4696294069290161]], [[0.8829472064971924], [0.4686294198036194]],
            [[0.8819472193717957], [0.46762943267822266]], [[0.8809472322463989], [0.4666294455528259]],
            [[0.8799472451210022], [0.4656294584274292]], [[0.8789472579956055], [0.46462947130203247]],
            [[0.8779472708702087], [0.46362948417663574]], [[0.876947283744812], [0.462629497051239]],
            [[0.8759472966194153], [0.4616295099258423]], [[0.8749473094940186], [0.46062952280044556]],
            [[0.8739473223686218], [0.45962953567504883]], [[0.8729473352432251], [0.4586295485496521]],
            [[0.8719473481178284], [0.45762956142425537]], [[0.8709473609924316], [0.45662957429885864]],
            [[0.8699473738670349], [0.4556295871734619]], [[0.8689473867416382], [0.4546296000480652]],
            [[0.8679473996162415], [0.45362961292266846]], [[0.8669474124908447], [0.45262962579727173]],
            [[0.865947425365448], [0.451629638671875]], [[0.8649474382400513], [0.45062965154647827]],
            [[0.8639474511146545], [0.44962966442108154]], [[0.8629474639892578], [0.4486296772956848]],
            [[0.8619474768638611], [0.4476296901702881]], [[0.8609474897384644], [0.44662970304489136]],
            [[0.8599475026130676], [0.44562971591949463]], [[0.8589475154876709], [0.4446297287940979]],
            [[0.8579475283622742], [0.44362974166870117]], [[0.8569475412368774], [0.44262975454330444]],
            [[0.8559475541114807], [0.4416297674179077]], [[0.854947566986084], [0.440629780292511]],
            [[0.8539475798606873], [0.43962979316711426]], [[0.8529475927352905], [0.43862980604171753]],
            [[0.8519476056098938], [0.4376298189163208]], [[0.8509476184844971], [0.4366298317909241]],
            [[0.8499476313591003], [0.43562984466552734]], [[0.8489476442337036], [0.4346298575401306]],
            [[0.8479476571083069], [0.4336298704147339]], [[0.8469476699829102], [0.43262988328933716]],
            [[0.8459476828575134], [0.43162989616394043]], [[0.8449476957321167], [0.4306299090385437]],
            [[0.84394770860672], [0.429629921913147]], [[0.8429477214813232], [0.42862993478775024]],
            [[0.8419477343559265], [0.4276299476623535]], [[0.8409477472305298], [0.4266299605369568]],
            [[0.8399477601051331], [0.42562997341156006]], [[0.8389477729797363], [0.42462998628616333]],
            [[0.8379477858543396], [0.4236299991607666]], [[0.8369477987289429], [0.4226300120353699]],
            [[0.8359478116035461], [0.42163002490997314]], [[0.8349478244781494], [0.4206300377845764]],
            [[0.8339478373527527], [0.4196300506591797]], [[0.832947850227356], [0.41863006353378296]],
            [[0.8319478631019592], [0.41763007640838623]], [[0.8309478759765625], [0.4166300892829895]],
            [[0.8299478888511658], [0.4156301021575928]], [[0.828947901725769], [0.41463011503219604]],
            [[0.8279479146003723], [0.4136301279067993]], [[0.8269479274749756], [0.4126301407814026]],
            [[0.8259479403495789], [0.41163015365600586]], [[0.8249479532241821], [0.41063016653060913]],
            [[0.8239479660987854], [0.4096301794052124]], [[0.8229479789733887], [0.4086301922798157]],
            [[0.8219479918479919], [0.40763020515441895]], [[0.8209480047225952], [0.4066302180290222]]], 'float32')

        weights = tf.Variable([[0.9189467373291287], [0.5046289624616127]], trainable=True, dtype='float32')
        optimizer = Lion(learning_rate=0.001, weight_decay=0.0, beta_1=0.9, beta_2=0.99)

        for e in range(10):
            for b in range(10):
                with tf.GradientTape() as tape:
                    loss = tf.reduce_mean((targets[b] - logits[b] @ weights) ** 2)
                grads = tape.gradient(loss, [weights])
                optimizer.apply_gradients(zip(grads, [weights]))

                actual = self.evaluate(weights)
                self.assertAllClose(actual, expected[e * 10 + b])

    def test_sparse_value(self):
        indices = tf.constant([
            [0, 1, 2, 3], [4, 3, 2, 1], [0, 1, 2, 3], [4, 3, 2, 1], [0, 1, 2, 3], [4, 3, 2, 1], [0, 4, 3, 2],
            [1, 0, 4, 3], [2, 1, 0, 4], [3, 2, 1, 0]], 'int32')
        targets = tf.ones([10, 4, 2], 'float32')
        expected = np.array([
            [[0.24022160470485687, 0.3754851222038269], [0.12567898631095886, 0.5834735631942749],
             [0.032581694424152374, 0.5732573866844177], [0.829765260219574, 0.3169560432434082],
             [0.09411077201366425, 0.33044469356536865]],
            [[0.24022160470485687, 0.3754851222038269], [0.12667898833751678, 0.5844735503196716],
             [0.03358169272542, 0.5742573738098145], [0.8307652473449707, 0.31795603036880493],
             [0.09511077404022217, 0.3314446806907654]],
            [[0.2412216067314148, 0.37648510932922363], [0.1276789903640747, 0.5854735374450684],
             [0.03458169102668762, 0.5752573609352112], [0.8317652344703674, 0.31895601749420166],
             [0.09511077404022217, 0.3314446806907654]],
            [[0.2412216067314148, 0.37648510932922363], [0.12867899239063263, 0.5864735245704651],
             [0.035581689327955246, 0.5762573480606079], [0.8327652215957642, 0.3199560046195984],
             [0.09611077606678009, 0.3324446678161621]],
            [[0.24222160875797272, 0.37748509645462036], [0.12967899441719055, 0.5874735116958618],
             [0.03658168762922287, 0.5772573351860046], [0.8337652087211609, 0.3209559917449951],
             [0.09611077606678009, 0.3324446678161621]],
            [[0.24222160875797272, 0.37748509645462036], [0.13067899644374847, 0.5884734988212585],
             [0.037581685930490494, 0.5782573223114014], [0.8347651958465576, 0.32195597887039185],
             [0.09711077809333801, 0.33344465494155884]],
            [[0.24322161078453064, 0.3784850835800171], [0.13067899644374847, 0.5884734988212585],
             [0.03858168423175812, 0.5792573094367981], [0.8357651829719543, 0.3229559659957886],
             [0.09811078011989594, 0.33444464206695557]],
            [[0.24422161281108856, 0.3794850707054138], [0.1316789984703064, 0.5894734859466553],
             [0.03858168423175812, 0.5792573094367981], [0.8367651700973511, 0.3239559531211853],
             [0.09911078214645386, 0.3354446291923523]],
            [[0.24522161483764648, 0.38048505783081055], [0.13267900049686432, 0.590473473072052],
             [0.03958168253302574, 0.5802572965621948], [0.8367651700973511, 0.3239559531211853],
             [0.10011078417301178, 0.336444616317749]],
            [[0.2462216168642044, 0.3814850449562073], [0.13367900252342224, 0.5914734601974487],
             [0.040581680834293365, 0.5812572836875916], [0.8377651572227478, 0.32495594024658203],
             [0.10011078417301178, 0.336444616317749]],
            [[0.24722161889076233, 0.382485032081604], [0.13467900454998016, 0.5924734473228455],
             [0.04158167913556099, 0.5822572708129883], [0.8387651443481445, 0.32595592737197876],
             [0.10011078417301178, 0.336444616317749]],
            [[0.24722161889076233, 0.382485032081604], [0.13567900657653809, 0.5934734344482422],
             [0.04258167743682861, 0.583257257938385], [0.8397651314735413, 0.3269559144973755],
             [0.1011107861995697, 0.33744460344314575]],
            [[0.24822162091732025, 0.38348501920700073], [0.136679008603096, 0.5944734215736389],
             [0.04358167573809624, 0.5842572450637817], [0.840765118598938, 0.3279559016227722],
             [0.1011107861995697, 0.33744460344314575]],
            [[0.24822162091732025, 0.38348501920700073], [0.13767901062965393, 0.5954734086990356],
             [0.04458167403936386, 0.5852572321891785], [0.8417651057243347, 0.32895588874816895],
             [0.10211078822612762, 0.3384445905685425]],
            [[0.24922162294387817, 0.38448500633239746], [0.13867901265621185, 0.5964733958244324],
             [0.045581672340631485, 0.5862572193145752], [0.8427650928497314, 0.3299558758735657],
             [0.10211078822612762, 0.3384445905685425]],
            [[0.24922162294387817, 0.38448500633239746], [0.13967901468276978, 0.5974733829498291],
             [0.04658167064189911, 0.5872572064399719], [0.8437650799751282, 0.3309558629989624],
             [0.10311079025268555, 0.3394445776939392]],
            [[0.2502216100692749, 0.3854849934577942], [0.13967901468276978, 0.5974733829498291],
             [0.04758166894316673, 0.5882571935653687], [0.8447650671005249, 0.33195585012435913],
             [0.10411079227924347, 0.34044456481933594]],
            [[0.25122159719467163, 0.3864849805831909], [0.1406790167093277, 0.5984733700752258],
             [0.04758166894316673, 0.5882571935653687], [0.8457650542259216, 0.33295583724975586],
             [0.10511079430580139, 0.34144455194473267]],
            [[0.25222158432006836, 0.38748496770858765], [0.14167901873588562, 0.5994733572006226],
             [0.04858166724443436, 0.5892571806907654], [0.8457650542259216, 0.33295583724975586],
             [0.10611079633235931, 0.3424445390701294]],
            [[0.2532215714454651, 0.3884849548339844], [0.14267902076244354, 0.6004733443260193],
             [0.04958166554570198, 0.5902571678161621], [0.8467650413513184, 0.3339558243751526],
             [0.10611079633235931, 0.3424445390701294]],
            [[0.2542215585708618, 0.3894849419593811], [0.14367902278900146, 0.601473331451416],
             [0.050581663846969604, 0.5912571549415588], [0.8477650284767151, 0.3349558115005493],
             [0.10611079633235931, 0.3424445390701294]],
            [[0.2542215585708618, 0.3894849419593811], [0.1446790248155594, 0.6024733185768127],
             [0.05158166214823723, 0.5922571420669556], [0.8487650156021118, 0.33595579862594604],
             [0.10711079835891724, 0.3434445261955261]],
            [[0.25522154569625854, 0.39048492908477783], [0.1456790268421173, 0.6034733057022095],
             [0.05258166044950485, 0.5932571291923523], [0.8497650027275085, 0.3369557857513428],
             [0.10711079835891724, 0.3434445261955261]],
            [[0.25522154569625854, 0.39048492908477783], [0.14667902886867523, 0.6044732928276062],
             [0.053581658750772476, 0.594257116317749], [0.8507649898529053, 0.3379557728767395],
             [0.10811080038547516, 0.34444451332092285]],
            [[0.2562215328216553, 0.39148491621017456], [0.14767903089523315, 0.6054732799530029],
             [0.0545816570520401, 0.5952571034431458], [0.851764976978302, 0.33895576000213623],
             [0.10811080038547516, 0.34444451332092285]],
            [[0.2562215328216553, 0.39148491621017456], [0.14867903292179108, 0.6064732670783997],
             [0.055581655353307724, 0.5962570905685425], [0.8527649641036987, 0.33995574712753296],
             [0.10911080241203308, 0.3454445004463196]],
            [[0.257221519947052, 0.3924849033355713], [0.14867903292179108, 0.6064732670783997],
             [0.05658165365457535, 0.5972570776939392], [0.8537649512290955, 0.3409557342529297],
             [0.110110804438591, 0.3464444875717163]],
            [[0.25822150707244873, 0.393484890460968], [0.149679034948349, 0.6074732542037964],
             [0.05658165365457535, 0.5972570776939392], [0.8547649383544922, 0.3419557213783264],
             [0.11111080646514893, 0.34744447469711304]],
            [[0.25922149419784546, 0.39448487758636475], [0.15067903697490692, 0.6084732413291931],
             [0.05758165195584297, 0.5982570648193359], [0.8547649383544922, 0.3419557213783264],
             [0.11211080849170685, 0.34844446182250977]],
            [[0.2602214813232422, 0.3954848647117615], [0.15167903900146484, 0.6094732284545898],
             [0.058581650257110596, 0.5992570519447327], [0.8557649254798889, 0.34295570850372314],
             [0.11211080849170685, 0.34844446182250977]],
            [[0.2612214684486389, 0.3964848518371582], [0.15267904102802277, 0.6104732155799866],
             [0.05958164855837822, 0.6002570390701294], [0.8567649126052856, 0.3439556956291199],
             [0.11211080849170685, 0.34844446182250977]],
            [[0.2612214684486389, 0.3964848518371582], [0.1536790430545807, 0.6114732027053833],
             [0.060581646859645844, 0.6012570261955261], [0.8577648997306824, 0.3449556827545166],
             [0.11311081051826477, 0.3494444489479065]],
            [[0.26222145557403564, 0.39748483896255493], [0.1546790450811386, 0.61247318983078],
             [0.06158164516091347, 0.6022570133209229], [0.8587648868560791, 0.34595566987991333],
             [0.11311081051826477, 0.3494444489479065]],
            [[0.26222145557403564, 0.39748483896255493], [0.15567904710769653, 0.6134731769561768],
             [0.06258164346218109, 0.6032570004463196], [0.8597648739814758, 0.34695565700531006],
             [0.11411081254482269, 0.3504444360733032]],
            [[0.2632214426994324, 0.39848482608795166], [0.15667904913425446, 0.6144731640815735],
             [0.06358164548873901, 0.6042569875717163], [0.8607648611068726, 0.3479556441307068],
             [0.11411081254482269, 0.3504444360733032]],
            [[0.2632214426994324, 0.39848482608795166], [0.15767905116081238, 0.6154731512069702],
             [0.06458164751529694, 0.605256974697113], [0.8617648482322693, 0.3489556312561035],
             [0.11511081457138062, 0.35144442319869995]],
            [[0.2642214298248291, 0.3994848132133484], [0.15767905116081238, 0.6154731512069702],
             [0.06558164954185486, 0.6062569618225098], [0.862764835357666, 0.34995561838150024],
             [0.11611081659793854, 0.3524444103240967]],
            [[0.26522141695022583, 0.4004848003387451], [0.1586790531873703, 0.6164731383323669],
             [0.06558164954185486, 0.6062569618225098], [0.8637648224830627, 0.350955605506897],
             [0.11711081862449646, 0.3534443974494934]],
            [[0.26622140407562256, 0.40148478746414185], [0.15967905521392822, 0.6174731254577637],
             [0.06658165156841278, 0.6072569489479065], [0.8637648224830627, 0.350955605506897],
             [0.11811082065105438, 0.35444438457489014]],
            [[0.2672213912010193, 0.4024847745895386], [0.16067905724048615, 0.6184731125831604],
             [0.0675816535949707, 0.6082569360733032], [0.8647648096084595, 0.3519555926322937],
             [0.11811082065105438, 0.35444438457489014]],
            [[0.268221378326416, 0.4034847617149353], [0.16167905926704407, 0.6194730997085571],
             [0.06858165562152863, 0.6092569231987], [0.8657647967338562, 0.35295557975769043],
             [0.11811082065105438, 0.35444438457489014]],
            [[0.268221378326416, 0.4034847617149353], [0.162679061293602, 0.6204730868339539],
             [0.06958165764808655, 0.6102569103240967], [0.8667647838592529, 0.35395556688308716],
             [0.1191108226776123, 0.35544437170028687]],
            [[0.26922136545181274, 0.40448474884033203], [0.1636790633201599, 0.6214730739593506],
             [0.07058165967464447, 0.6112568974494934], [0.8677647709846497, 0.3549555540084839],
             [0.1191108226776123, 0.35544437170028687]],
            [[0.26922136545181274, 0.40448474884033203], [0.16467906534671783, 0.6224730610847473],
             [0.07158166170120239, 0.6122568845748901], [0.8687647581100464, 0.3559555411338806],
             [0.12011082470417023, 0.3564443588256836]],
            [[0.2702213525772095, 0.40548473596572876], [0.16567906737327576, 0.623473048210144],
             [0.07258166372776031, 0.6132568717002869], [0.8697647452354431, 0.35695552825927734],
             [0.12011082470417023, 0.3564443588256836]],
            [[0.2702213525772095, 0.40548473596572876], [0.16667906939983368, 0.6244730353355408],
             [0.07358166575431824, 0.6142568588256836], [0.8707647323608398, 0.3579555153846741],
             [0.12111082673072815, 0.3574443459510803]],
            [[0.2712213397026062, 0.4064847230911255], [0.16667906939983368, 0.6244730353355408],
             [0.07458166778087616, 0.6152568459510803], [0.8717647194862366, 0.3589555025100708],
             [0.12211082875728607, 0.35844433307647705]],
            [[0.27222132682800293, 0.4074847102165222], [0.1676790714263916, 0.6254730224609375],
             [0.07458166778087616, 0.6152568459510803], [0.8727647066116333, 0.35995548963546753],
             [0.123110830783844, 0.3594443202018738]],
            [[0.27322131395339966, 0.40848469734191895], [0.16867907345294952, 0.6264730095863342],
             [0.07558166980743408, 0.616256833076477], [0.8727647066116333, 0.35995548963546753],
             [0.12411083281040192, 0.3604443073272705]],
            [[0.2742213010787964, 0.4094846844673157], [0.16967907547950745, 0.627472996711731],
             [0.076581671833992, 0.6172568202018738], [0.87376469373703, 0.36095547676086426],
             [0.12411083281040192, 0.3604443073272705]],
            [[0.2752212882041931, 0.4104846715927124], [0.17067907750606537, 0.6284729838371277],
             [0.07758167386054993, 0.6182568073272705], [0.8747646808624268, 0.361955463886261],
             [0.12411083281040192, 0.3604443073272705]],
            [[0.2752212882041931, 0.4104846715927124], [0.1716790795326233, 0.6294729709625244],
             [0.07858167588710785, 0.6192567944526672], [0.8757646679878235, 0.3629554510116577],
             [0.12511083483695984, 0.36144429445266724]],
            [[0.27622127532958984, 0.41148465871810913], [0.1726790815591812, 0.6304729580879211],
             [0.07958167791366577, 0.620256781578064], [0.8767646551132202, 0.36395543813705444],
             [0.12511083483695984, 0.36144429445266724]],
            [[0.27622127532958984, 0.41148465871810913], [0.17367908358573914, 0.6314729452133179],
             [0.0805816799402237, 0.6212567687034607], [0.8777646422386169, 0.36495542526245117],
             [0.12611083686351776, 0.36244428157806396]],
            [[0.2772212624549866, 0.41248464584350586], [0.17467908561229706, 0.6324729323387146],
             [0.08158168196678162, 0.6222567558288574], [0.8787646293640137, 0.3659554123878479],
             [0.12611083686351776, 0.36244428157806396]],
            [[0.2772212624549866, 0.41248464584350586], [0.17567908763885498, 0.6334729194641113],
             [0.08258168399333954, 0.6232567429542542], [0.8797646164894104, 0.36695539951324463],
             [0.12711083889007568, 0.3634442687034607]],
            [[0.2782212495803833, 0.4134846329689026], [0.17567908763885498, 0.6334729194641113],
             [0.08358168601989746, 0.6242567300796509], [0.8807646036148071, 0.36795538663864136],
             [0.1281108409166336, 0.3644442558288574]],
            [[0.27922123670578003, 0.4144846200942993], [0.1766790896654129, 0.6344729065895081],
             [0.08358168601989746, 0.6242567300796509], [0.8817645907402039, 0.3689553737640381],
             [0.12911084294319153, 0.36544424295425415]],
            [[0.28022122383117676, 0.41548460721969604], [0.17767909169197083, 0.6354728937149048],
             [0.08458168804645538, 0.6252567172050476], [0.8817645907402039, 0.3689553737640381],
             [0.13011084496974945, 0.3664442300796509]],
            [[0.2812212109565735, 0.4164845943450928], [0.17867909371852875, 0.6364728808403015],
             [0.0855816900730133, 0.6262567043304443], [0.8827645778656006, 0.3699553608894348],
             [0.13011084496974945, 0.3664442300796509]],
            [[0.2822211980819702, 0.4174845814704895], [0.17967909574508667, 0.6374728679656982],
             [0.08658169209957123, 0.6272566914558411], [0.8837645649909973, 0.37095534801483154],
             [0.13011084496974945, 0.3664442300796509]],
            [[0.2822211980819702, 0.4174845814704895], [0.1806790977716446, 0.638472855091095],
             [0.08758169412612915, 0.6282566785812378], [0.884764552116394, 0.37195533514022827],
             [0.13111084699630737, 0.3674442172050476]],
            [[0.28322118520736694, 0.41848456859588623], [0.18167909979820251, 0.6394728422164917],
             [0.08858169615268707, 0.6292566657066345], [0.8857645392417908, 0.372955322265625],
             [0.13111084699630737, 0.3674442172050476]],
            [[0.28322118520736694, 0.41848456859588623], [0.18267910182476044, 0.6404728293418884],
             [0.089581698179245, 0.6302566528320312], [0.8867645263671875, 0.37395530939102173],
             [0.1321108490228653, 0.36844420433044434]],
            [[0.28422117233276367, 0.41948455572128296], [0.18367910385131836, 0.6414728164672852],
             [0.09058170020580292, 0.631256639957428], [0.8877645134925842, 0.37495529651641846],
             [0.1321108490228653, 0.36844420433044434]],
            [[0.28422117233276367, 0.41948455572128296], [0.18467910587787628, 0.6424728035926819],
             [0.09158170223236084, 0.6322566270828247], [0.888764500617981, 0.3759552836418152],
             [0.13311085104942322, 0.36944419145584106]],
            [[0.2852211594581604, 0.4204845428466797], [0.18467910587787628, 0.6424728035926819],
             [0.09258170425891876, 0.6332566142082214], [0.8897644877433777, 0.3769552707672119],
             [0.13411085307598114, 0.3704441785812378]],
            [[0.28622114658355713, 0.4214845299720764], [0.1856791079044342, 0.6434727907180786],
             [0.09258170425891876, 0.6332566142082214], [0.8907644748687744, 0.37795525789260864],
             [0.13511085510253906, 0.3714441657066345]],
            [[0.28722113370895386, 0.42248451709747314], [0.18667910993099213, 0.6444727778434753],
             [0.09358170628547668, 0.6342566013336182], [0.8907644748687744, 0.37795525789260864],
             [0.13611085712909698, 0.37244415283203125]],
            [[0.2882211208343506, 0.4234845042228699], [0.18767911195755005, 0.6454727649688721],
             [0.0945817083120346, 0.6352565884590149], [0.8917644619941711, 0.37895524501800537],
             [0.13611085712909698, 0.37244415283203125]],
            [[0.2892211079597473, 0.4244844913482666], [0.18867911398410797, 0.6464727520942688],
             [0.09558171033859253, 0.6362565755844116], [0.8927644491195679, 0.3799552321434021],
             [0.13611085712909698, 0.37244415283203125]],
            [[0.2892211079597473, 0.4244844913482666], [0.1896791160106659, 0.6474727392196655],
             [0.09658171236515045, 0.6372565627098083], [0.8937644362449646, 0.38095521926879883],
             [0.1371108591556549, 0.373444139957428]],
            [[0.29022109508514404, 0.42548447847366333], [0.19067911803722382, 0.6484727263450623],
             [0.09758171439170837, 0.6382565498352051], [0.8947644233703613, 0.38195520639419556],
             [0.1371108591556549, 0.373444139957428]],
            [[0.29022109508514404, 0.42548447847366333], [0.19167912006378174, 0.649472713470459],
             [0.0985817164182663, 0.6392565369606018], [0.8957644104957581, 0.3829551935195923],
             [0.13811086118221283, 0.3744441270828247]],
            [[0.29122108221054077, 0.42648446559906006], [0.19267912209033966, 0.6504727005958557],
             [0.09958171844482422, 0.6402565240859985], [0.8967643976211548, 0.383955180644989],
             [0.13811086118221283, 0.3744441270828247]],
            [[0.29122108221054077, 0.42648446559906006], [0.19367912411689758, 0.6514726877212524],
             [0.10058172047138214, 0.6412565112113953], [0.8977643847465515, 0.38495516777038574],
             [0.13911086320877075, 0.37544411420822144]],
            [[0.2922210693359375, 0.4274844527244568], [0.19367912411689758, 0.6514726877212524],
             [0.10158172249794006, 0.642256498336792], [0.8987643718719482, 0.38595515489578247],
             [0.14011086523532867, 0.37644410133361816]],
            [[0.29322105646133423, 0.4284844398498535], [0.1946791261434555, 0.6524726748466492],
             [0.10158172249794006, 0.642256498336792], [0.899764358997345, 0.3869551420211792],
             [0.1411108672618866, 0.3774440884590149]],
            [[0.29422104358673096, 0.42948442697525024], [0.19567912817001343, 0.6534726619720459],
             [0.10258172452449799, 0.6432564854621887], [0.899764358997345, 0.3869551420211792],
             [0.14211086928844452, 0.3784440755844116]],
            [[0.2952210307121277, 0.430484414100647], [0.19667913019657135, 0.6544726490974426],
             [0.10358172655105591, 0.6442564725875854], [0.9007643461227417, 0.3879551291465759],
             [0.14211086928844452, 0.3784440755844116]],
            [[0.2962210178375244, 0.4314844012260437], [0.19767913222312927, 0.6554726362228394],
             [0.10458172857761383, 0.6452564597129822], [0.9017643332481384, 0.38895511627197266],
             [0.14211086928844452, 0.3784440755844116]],
            [[0.2962210178375244, 0.4314844012260437], [0.1986791342496872, 0.6564726233482361],
             [0.10558173060417175, 0.6462564468383789], [0.9027643203735352, 0.3899551033973694],
             [0.14311087131500244, 0.37944406270980835]],
            [[0.29722100496292114, 0.43248438835144043], [0.19967913627624512, 0.6574726104736328],
             [0.10658173263072968, 0.6472564339637756], [0.9037643074989319, 0.3909550905227661],
             [0.14311087131500244, 0.37944406270980835]],
            [[0.29722100496292114, 0.43248438835144043], [0.20067913830280304, 0.6584725975990295],
             [0.1075817346572876, 0.6482564210891724], [0.9047642946243286, 0.39195507764816284],
             [0.14411087334156036, 0.3804440498352051]],
            [[0.29822099208831787, 0.43348437547683716], [0.20167914032936096, 0.6594725847244263],
             [0.10858173668384552, 0.6492564082145691], [0.9057642817497253, 0.39295506477355957],
             [0.14411087334156036, 0.3804440498352051]],
            [[0.29822099208831787, 0.43348437547683716], [0.20267914235591888, 0.660472571849823],
             [0.10958173871040344, 0.6502563953399658], [0.9067642688751221, 0.3939550518989563],
             [0.1451108753681183, 0.3814440369606018]],
            [[0.2992209792137146, 0.4344843626022339], [0.20267914235591888, 0.660472571849823],
             [0.11058174073696136, 0.6512563824653625], [0.9077642560005188, 0.394955039024353],
             [0.1461108773946762, 0.38244402408599854]],
            [[0.30022096633911133, 0.4354843497276306], [0.2036791443824768, 0.6614725589752197],
             [0.11058174073696136, 0.6512563824653625], [0.9087642431259155, 0.39595502614974976],
             [0.14711087942123413, 0.38344401121139526]],
            [[0.30122095346450806, 0.43648433685302734], [0.20467914640903473, 0.6624725461006165],
             [0.11158174276351929, 0.6522563695907593], [0.9087642431259155, 0.39595502614974976],
             [0.14811088144779205, 0.384443998336792]],
            [[0.3022209405899048, 0.4374843239784241], [0.20567914843559265, 0.6634725332260132],
             [0.11258174479007721, 0.653256356716156], [0.9097642302513123, 0.3969550132751465],
             [0.14811088144779205, 0.384443998336792]],
            [[0.3032209277153015, 0.4384843111038208], [0.20667915046215057, 0.6644725203514099],
             [0.11358174681663513, 0.6542563438415527], [0.910764217376709, 0.3979550004005432],
             [0.14811088144779205, 0.384443998336792]],
            [[0.3032209277153015, 0.4384843111038208], [0.2076791524887085, 0.6654725074768066],
             [0.11458174884319305, 0.6552563309669495], [0.9117642045021057, 0.39895498752593994],
             [0.14911088347434998, 0.3854439854621887]],
            [[0.30422091484069824, 0.43948429822921753], [0.20867915451526642, 0.6664724946022034],
             [0.11558175086975098, 0.6562563180923462], [0.9127641916275024, 0.39995497465133667],
             [0.14911088347434998, 0.3854439854621887]],
            [[0.30422091484069824, 0.43948429822921753], [0.20967915654182434, 0.6674724817276001],
             [0.1165817528963089, 0.6572563052177429], [0.9137641787528992, 0.4009549617767334],
             [0.1501108855009079, 0.38644397258758545]],
            [[0.30522090196609497, 0.44048428535461426], [0.21067915856838226, 0.6684724688529968],
             [0.11758175492286682, 0.6582562923431396], [0.9147641658782959, 0.4019549489021301],
             [0.1501108855009079, 0.38644397258758545]],
            [[0.30522090196609497, 0.44048428535461426], [0.21167916059494019, 0.6694724559783936],
             [0.11858175694942474, 0.6592562794685364], [0.9157641530036926, 0.40295493602752686],
             [0.15111088752746582, 0.3874439597129822]],
            [[0.3062208890914917, 0.441484272480011], [0.21167916059494019, 0.6694724559783936],
             [0.11958175897598267, 0.6602562665939331], [0.9167641401290894, 0.4039549231529236],
             [0.15211088955402374, 0.3884439468383789]],
            [[0.3072208762168884, 0.4424842596054077], [0.2126791626214981, 0.6704724431037903],
             [0.11958175897598267, 0.6602562665939331], [0.9177641272544861, 0.4049549102783203],
             [0.15311089158058167, 0.38944393396377563]],
            [[0.30822086334228516, 0.44348424673080444], [0.21367916464805603, 0.671472430229187],
             [0.12058176100254059, 0.6612562537193298], [0.9177641272544861, 0.4049549102783203],
             [0.1541108936071396, 0.39044392108917236]],
            [[0.3092208504676819, 0.44448423385620117], [0.21467916667461395, 0.6724724173545837],
             [0.12158176302909851, 0.6622562408447266], [0.9187641143798828, 0.40595489740371704],
             [0.1541108936071396, 0.39044392108917236]]], 'float32')

        weights = tf.Variable([
            [0.23922160713307927, 0.3744851446884956], [0.12467899195548227, 0.582473576084052],
            [0.03158169648583875, 0.5722574065524645], [0.8287652988660922, 0.315956053134146],
            [0.09411076902398452, 0.33044468551739103]], trainable=True, dtype='float32')
        optimizer = Lion(learning_rate=0.001, weight_decay=0.0, beta_1=0.9, beta_2=0.99)

        for e in range(10):
            for b in range(10):
                with tf.GradientTape() as tape:
                    loss = tf.reduce_mean((targets[b] - tf.nn.embedding_lookup(weights, indices[b])) ** 2)
                grads = tape.gradient(loss, [weights])
                optimizer.apply_gradients(zip(grads, [weights]))

                actual = self.evaluate(weights)
                self.assertAllClose(actual, expected[e * 10 + b])

    def test_lr(self):
        opt_1 = Lion(learning_rate=1.0)
        opt_2 = Lion(learning_rate=lambda: tf.constant(0.5, 'float32'))
        opt_3 = Lion.from_config(opt_2.get_config())

        self.assertIsInstance(opt_1.lr, tf.Variable)
        self.assertIsInstance(opt_2.lr, tf.Variable)
        self.assertIsInstance(opt_3.lr, tf.Variable)

        self.assertAllClose(self.evaluate(opt_1.learning_rate), 1.0)
        self.assertAllClose(self.evaluate(opt_2.learning_rate), 0.5)
        self.assertAllClose(self.evaluate(opt_3.learning_rate), 0.5)


if __name__ == "__main__":
    tf.test.main()
